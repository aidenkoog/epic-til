# Payment

정리될 내용들은 아래와 같습니다.

- 개념 / 용어 정의, 사용 이유 등

## 앱 내 카드 등록 통한 결제 처리 동작

- 카드 등록 기능의 구조
    - 앱에서 카드 등록 기능은 보통 PG사(Payment Gateway)와 연동되어 작동하며 주요 특징은 다음과 같음
	    - 공통 카드 등록
	    - 사용자가 등록한 카드는 앱에 저장되지 않고 PG사 또는 VAN사(결제 대행사)에서 토큰화(Tokenization) 과정을 통해 관리
	    - 앱은 이 토큰화된 정보를 활용하여 결제를 진행하며, 카드 정보를 직접 보유하지 않음
	    - 이 방식은 보안성과 편리성을 동시에 제공하며, 사용자 입장에서 매장에 상관없이 동일한 결제 수단을 사용할 수 있도록 함

- 매장별 사업자 구조
    - 스타벅스와 같은 대형 브랜드에서 매장별 사업자가 다를 수 있는 이유는 다음과 같음
        - 프랜차이즈 구조
        - 매장은 각기 다른 프랜차이즈 사업자(가맹점) 소유일 수 있음
            - 예를 들어, 스타벅스 매장 A는 사업자 A, 매장 B는 사업자 B로 등록될 수 있습니다.
        - 직영점 구조
            - 일부 매장은 본사가 직접 운영할 수 있으며, 사업자가 하나로 통합될 수도 있습니다.
        - 그러나 많은 경우, 프랜차이즈 가맹점 방식으로 운영될 것으로 추측

- 결제와 정산의 흐름
    - 사용자가 카드 등록 후 특정 매장에서 결제할 때, 결제와 정산은 다음 단계로 이루어짐
    - 단계
        - 결제 요청
	        - 사용자가 앱에서 결제 버튼을 누르면, 앱은 PG사에 결제 요청을 보냄
	        - PG사는 카드 정보를 토큰화된 데이터로 전달받아 카드사와의 결제를 처리

        - 매장 정보 전송
	        - 결제 요청에는 매장의 고유 식별자(사업자 정보)가 포함
	        - 매장 ID, 사업자 등록 번호 등이 PG사로 함께 전달
	        - 이 정보를 통해 PG사는 어느 매장(사업자)에서 결제가 이루어졌는지 식별

        - 결제 승인 및 완료
	        - PG사는 카드사로부터 결제 승인을 받아내고, 매장의 사업자 계좌로 결제 금액을 전달할 준비

        - 정산
	        - PG사는 매출 데이터를 매장별로 분리하여 각 사업자에게 정산
	            - 예를 들어, 매장 A에서 발생한 결제는 사업자 A 계좌로, 매장 B에서 발생한 결제는 사업자 B 계좌로 입금
	        - PG사가 결제 수수료를 공제한 후 각 사업자에게 송금

- 정산 방식의 세부 구조
    - 매장별 사업자 정보가 다르더라도, 결제와 정산이 가능한 이유는 PG사가 모든 결제 흐름을 중앙에서 관리하기 때문임
    - 예시
	    - 사용자가 매장 A에서 5,000원을 결제하면:
	        - 사업자 A의 PG 계정으로 매출이 기록
	        - PG사가 사업자 A의 계좌로 정산금을 송금
	    - 사용자가 매장 B에서 7,000원을 결제하면:
	        - 사업자 B의 PG 계정으로 매출이 기록
	        - PG사가 사업자 B의 계좌로 정산금을 송금
        이 과정에서 PG사가 매출 정산 데이터를 정확히 관리하기 때문에, 사용자는 같은 앱과 카드를 사용하더라도 매장별 사업자가 다르게 정산됨

- 스타벅스의 사례
    - 스타벅스의 경우, 대부분의 매장은 직영점으로 운영되기 때문에 사업자 정보가 통합되어 있을 가능성이 있음
	    - 스타벅스 전용 결제 시스템
	    - 스타벅스는 자체 충전식 카드 및 앱 내 결제를 제공하며, 이는 본사가 중앙에서 통합 관리
	    - 충전된 금액은 “선불”로 본사 계정에 저장되며, 매장에서 결제 시 본사가 각 매장으로 내부 정산

- 결론
    - 앱에서 카드 등록과 매장별 결제 및 정산은 PG사의 중앙 집중화된 결제 시스템을 통해 이루어짐
    - 매장별로 사업자가 달라도, PG사는 매장 ID 및 사업자 정보를 활용하여 정확히 정산
    - 스타벅스와 같은 경우, 자체 결제 시스템이 더해져 보다 효율적인 정산 체계를 구축할 수 있음

## 페이먼트 연동 관련 내용 정리

- 앱에서 가맹점 시스템으로 주문하는 플로우 (스마트 오더링, 예. 스타벅스 등)
  - 가맹점 / 메뉴 선택
  - 주문하기
  - 주문 내용 전달 --> 가맹점 시스템
  - 주문 내용 전달에 대한 응답
  - 주문 정보 업데이트
  - 가맹점 시스템으로부터 정보 전달 받음 (예. 주문 접수 / 대기열 / 등등)
  - 주문 정보 업데이트
  - 주문 확인 사항 사용자에게 전달
  - 주문한 음식 또는 물건의 제조의 완료
  - 제조완료 정보 전달
  - 주문 정보 업데이트
  - 주문한 것에 대한 제조가 완료되었음을 사용자에게 표시
  - 주문한 물건 또는 음식을 픽업
- PG 사 연동 시 결제 처리 흐름
  - 결제 준비
  - 결제 준비 요청에 대한 응답
  - 결제 승인
  - 결제 승인 요청에 대한 응답
  - 아래는 결제 취소 건에 대한 흐름
    - 결제 취소 요청
    - 결제 취소 요청에 대한 거래 결과 응답
    - 기타 정보 (정산 정보, 영수증 정보 조회 및 응답 처리)
   
## PG, VAN 사 개념 정리

- 온라인이든 오프라인이든 상점, 카드사, 금융기관이 서로 결제 정보를 주고 받을 망이 필요
- 오프라인 결제의 핵심, Value Added Network Van은 카드사와 상점의 통신을 연결하는 부가가치통신망이라 보면 됨
  - 오프라인 상점에서 입력한 고객의 결제 데이터를 카드사로 안전하게 보내주는 역할
  - 결제 정보를 주고 받는 일종의 파이프 역할
  - 업장에서 계산할 때 사용하는 카드 단말기 / 포스 단말기 모두 VAN 기반
  - 오프라인, 소비자 - 가맹점 - VAN (중계) - 카드사
    - 카드사는 VAN 사용료 지급 의무
    - VAN사는 중계 역할만 수행
    - 가맹점의 매출액 지급은 밴사가 관여하지 않음
    - 가맹점은 8개의 카드사로부터 매출액 각각 지급 받음(?)
  - VAN : 데이터를 안전하고 정확하게 연결해주는 역할만 함 (매출 정산 등의 추가 서비스 제공하지 않음)
    - 포스 단말기나 매출 장부 서비스 등을 사용하지 않으면 8개의 카드사에서 발생한 매출 내역을 따로따로 관리해야 함
    - VAN은 수수료가 없어서 고정비 절감 가능하나 가게 운영자의 역할이 늘어남 (8개 카드사로부터 각각 다른 날짜에 매출액을 입금받아야 함)
    - 신용카드 가맹점과 신용카드 회사 사이에서 신용카드 결제를 중계해주는 부가사업자
    - 신용카드 결제 -> 밴사 -> 신용카드사
    - KSNET / KIS정보통신 / 나이스정보통신 / KOVAN / 금융결제원 / fiserv. / DAOU데이터 / Smartro / KICC / NHN KCP / JTNet / KOCES / SPC NETWORKS.
    - VAN 사가 없다면 -> 매장마다 신용카드사별 전용 결제 단말기를 각각 설치해야 되는 상황 발생
  - PG : 온라인 결제의 핵심
    - Payments Gateway, 신용카드사와 직접 계약하기 어려운 온라인 쇼핑몰을 대신해 결제 업무를 대신해 주는 역할
    - 온라인, 소비자 - 가맹점 - PG - VAN - 카드사
    - 카드사는 가맹점에서 발생한 매출액을 PG 사에 지급
    - PG 사는 중계 역할 + 정산 역할 같이 수행
    - PG 사는 매출액을 가맹점에 지급 (PG 수수료 정산)
    - 여러 곳의 카드사와 거래를 가능하게 할 뿐 아니라 PG사와 계약한 정산일에 맞춰 한 번에 매출액을 정산해 줌
    - (이 정산 시스템은 카드사마다 매출 금액 지급일이 달라 발생할 수 있는 혼란을 없애고 현금 흐름을 쉽게 파악 가능케 함)
  - 가맹점 입장에서 VAN, PG 관련 체감할 수 있는 큰 차이점은 수수료
    - VAN 사는 가맹점 업주에게 수수료를 받지 않고 카드사로부터 수수료를 받음
    - PG 사는 PG사가 카드사에 수수료를 내고 결제를 연동하는 구조, 그리고 카드사마다 다른 매출 정산 내역을 일괄로 정산해주는 역할도 해주기 때문에 수수료가 발생
    - (즉, 밴사와 다르게 연동 구조도 다르고 제공되는 서비스가 많기에 수수료가 발생하는 것이라 이해)
    - 대표 PG 사: 토스페이먼츠 / KG이니시스 / 나이스페이먼츠 / NHN한국사이버결제
    - 온라인 결제 서비스 중에서도 VAN의 역할만 해주는 곳도 존재, 수수료를 줄일것인가, 매출 관리나 정산 업무를 강화시킬것인가에 대해 확인 후 선택 필요 

## PG, VAN 개념, 관계
  
  - VAN 개념
    - 카드사에 카드정보를 전달하는 중간업체
    - VAN사는 PG 또는 카드 단말기가 수집한 카드정보가 안전하게 안전하게 카드사로 전달 될 수 있도록 하는 일을 수행
    - 이를 위한 API 등을 제공

    - 온라인 결제 플로우
      - PG사가 카드 결제를 요청하면 VAN사는 그 요청을 카드사로 보내고, 카드사가 결제 요청 결과를 보내면 VAN사는 그 결과를 PG 전달
    - 오프라인 결제 플로우
      - 오프라인 결제에서 사용되는 단말기는 VAN사에서 제공하는 단말기
      - 이 단말기를 통해 카드 정보를 카드사에 전달
      - 최근에는 웹 기반 POS 기기나 테이블 결제 기기들이 많아 지면서 오프라인 결제라고 하더라도 PG를 통한 결제가 많아짐
      - PG사에서 제공하는 오프라인 결제용 단말기가 있는것 처럼, 최근에는 오프라인이면 무조건 VAN 단말기다 라는 개념이 많이 사라지고 있는 추세

  - PG 개념
    - 우리나라는 여러가지 이유로 카드 정보를 수집하여 결제하는 방식을 지양
    - 카드결제를 사용하기 위해 PG는 별도의 SDK나 API를 제공해 해당 방식으로만 카드정보를 입력받도록 하고 있음
    - 입력 된 정보를 따로 수집하진 않고, 카드사로 전달
    - 경우에 따라 정기 결제 처리 등을 위해 카드사에서 발급하는 키를 저장하고 그 키를 통해 결제를 처리하기도 하지만, 카드 정보는 수집하지 않음
    - 우리나라의 PG 사업자는 KCP, 나이스정보통신, KG 이니시스, 카카오 등 총 362개사(23/06/12 기준)
      - (PG사업자가 되려면 자본금이 3억 이상이여야 하고 엄격한 보안을 유지 하는 등 요건이 매우 까다로움)
    - PG 마다 다르지만 규모가 큰 PG의 경우 VAN을 사용하지 않는 경우도 존재

  - 비인증 결제
    - 일반적으로 결제시 마다 결제에 필요한 정보를 입력받는데 이를 비인증 결제라 함
    - 비인증 결제는 'key-in 결제'와 '빌링 결제' 결제로 다시 나뉘게 됨
      - key-in 결제
        - 카드번호, 유효기간, 카드 명의자의 생년월일, 카드 비밀번호 앞 2자리와 같은 카드 정보를 직접 입력하여 결제하는 방식
        - 입력받는 방식의 구분으로는 온라인 결제의 경우 PG에서 제공하는 SDK를 이용하는 방법과 API를 이용하는 2가지 방법 존재
        - 오프라인 결제에서는 카드 단말기나 POS기기 에서 API 통신을 통해 카드 정보를 입력받아 결제가 이루어짐
        - PG사에서 제공하는 결제창(SDK)을 사용하는 방법
          - KG 이니시스의 결제창
            - PG사에서 제공해주는 결제창을 통해 카드정보를 수집받음
            - 정보수집을 PG사에서 받고 바로 VAN을 통해 카드사로 전달
            - 가장 안전한 방법이라 가장 많이 사용되고 있고, 국내 대부분의 PG에서 사용하는 방식

          - PG사에서 제공하는 API를 사용하는 방법
            - 라프텔의 API 결제
              - 결제창 방법의 경우 기존 사이트의 디자인과 다른 PG사의 결제창이 툭 튀어나와 쇼핑몰의 이용자들이 당황하는 경우 발생
              - 대부분의 쇼핑몰의 경우 서비스 자체 디자인 한 카드 결제창을 사용하기를 희망
              - 사용자로 부터 입력받은 카드정보를 API를 통해 PG사에 제출 가능
              - 현재 국내에서는 나이스정보통신, PAYAPP 등 많지 않은 곳에서만 지원하는 방식
              - 개발 시 쇼핑몰의 시스템에서는 카드정보를 수집하지 않도록 처리해야 함
              - 쇼핑몰에서 입력받은 카드정보를 안전하게 PG로 전달할 수 있도록 보안처리가 필요하고 이는 직접 구축 필수

      - 빌링 결제
        - 라프텔의 경우 월 1회 마다 정기적으로 요금이 결제되게 됨
        - 최초 1회 카드 정보를 입력받는 것은 키인 결제와 동일하지만, 최초 결제이후 발행되는 빌링키를 이용하여 다음 결제 부터는 빌링키를 통해 결제가 이루어 지게 하여 결제를 처리
          - 빌링 결제 개념
        - 플랫폼에서는 빌링키 정보를 서버에 안전하게 보관하고 이 정보를 바탕으로 결제를 처리

  - 다른 결제 방식 존재 유무
    - 국내에서는 카드 결제 시스템에서 키인결제와 빌링 결제 2가지 이외에는 현실적으로 다른 결제 방식을 사용하기는 어려움

  - 왜 카드정보를 수집하지 않는지에 대한 설명
    - 유출시의 피해
      - 카드 번호와 같은 민감 정보가 서버에 보관되어있고 만약 서버의 정보 유출로 카드 번호 등이 유출되어 금전적 피해가 발생되었다면 법적인 문제를 제외하고도 이는 심각한 피해를 발생시키게 됨

    - 법적인 책임
      - 여신전문금융업법 제 17조 ①항의 내용을 보면, 선행 조건이 있긴 하지만 해당 조건을 제외하고 보면 가맹점의 고의 또는 중과실이 증명 될 경우 그 손실의 전부 또는 일부를 가맹점이 부담해야 한다는 내용 존재
      - 고의 또는 중과실에 관한 내용도 있는데 "해킹, 전산장애, 내부자정보유출 등 부정한 방법으로 얻은 신용카드등의 정보를 이용하여 신용카드등을 사용한 거래"라는 내용이 포함되어있어 해킹으로 인한 유출에 대한 책임을 져야 함
    - 이러한 법률로 인해 카드 정보를 저장하지 않는 방식으로 시스템이 발전되어 왔음
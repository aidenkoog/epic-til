# Payment

정리될 내용들은 아래와 같습니다.

- 개념 / 용어 정의, 사용 이유 등

## 앱 내 카드 등록 통한 결제 처리 동작

- 카드 등록 기능의 구조
    - 앱에서 카드 등록 기능은 보통 PG사(Payment Gateway)와 연동되어 작동하며 주요 특징은 다음과 같음
	    - 공통 카드 등록
	    - 사용자가 등록한 카드는 앱에 저장되지 않고 PG사 또는 VAN사(결제 대행사)에서 토큰화(Tokenization) 과정을 통해 관리
	    - 앱은 이 토큰화된 정보를 활용하여 결제를 진행하며, 카드 정보를 직접 보유하지 않음
	    - 이 방식은 보안성과 편리성을 동시에 제공하며, 사용자 입장에서 매장에 상관없이 동일한 결제 수단을 사용할 수 있도록 함

- 매장별 사업자 구조
    - 스타벅스와 같은 대형 브랜드에서 매장별 사업자가 다를 수 있는 이유는 다음과 같음
        - 프랜차이즈 구조
        - 매장은 각기 다른 프랜차이즈 사업자(가맹점) 소유일 수 있음
            - 예를 들어, 스타벅스 매장 A는 사업자 A, 매장 B는 사업자 B로 등록될 수 있습니다.
        - 직영점 구조
            - 일부 매장은 본사가 직접 운영할 수 있으며, 사업자가 하나로 통합될 수도 있습니다.
        - 그러나 많은 경우, 프랜차이즈 가맹점 방식으로 운영될 것으로 추측

- 결제와 정산의 흐름
    - 사용자가 카드 등록 후 특정 매장에서 결제할 때, 결제와 정산은 다음 단계로 이루어짐
    - 단계
        - 결제 요청
	        - 사용자가 앱에서 결제 버튼을 누르면, 앱은 PG사에 결제 요청을 보냄
	        - PG사는 카드 정보를 토큰화된 데이터로 전달받아 카드사와의 결제를 처리

        - 매장 정보 전송
	        - 결제 요청에는 매장의 고유 식별자(사업자 정보)가 포함
	        - 매장 ID, 사업자 등록 번호 등이 PG사로 함께 전달
	        - 이 정보를 통해 PG사는 어느 매장(사업자)에서 결제가 이루어졌는지 식별

        - 결제 승인 및 완료
	        - PG사는 카드사로부터 결제 승인을 받아내고, 매장의 사업자 계좌로 결제 금액을 전달할 준비

        - 정산
	        - PG사는 매출 데이터를 매장별로 분리하여 각 사업자에게 정산
	            - 예를 들어, 매장 A에서 발생한 결제는 사업자 A 계좌로, 매장 B에서 발생한 결제는 사업자 B 계좌로 입금
	        - PG사가 결제 수수료를 공제한 후 각 사업자에게 송금

- 정산 방식의 세부 구조
    - 매장별 사업자 정보가 다르더라도, 결제와 정산이 가능한 이유는 PG사가 모든 결제 흐름을 중앙에서 관리하기 때문임
    - 예시
	    - 사용자가 매장 A에서 5,000원을 결제하면:
	        - 사업자 A의 PG 계정으로 매출이 기록
	        - PG사가 사업자 A의 계좌로 정산금을 송금
	    - 사용자가 매장 B에서 7,000원을 결제하면:
	        - 사업자 B의 PG 계정으로 매출이 기록
	        - PG사가 사업자 B의 계좌로 정산금을 송금
        이 과정에서 PG사가 매출 정산 데이터를 정확히 관리하기 때문에, 사용자는 같은 앱과 카드를 사용하더라도 매장별 사업자가 다르게 정산됨

- 스타벅스의 사례
    - 스타벅스의 경우, 대부분의 매장은 직영점으로 운영되기 때문에 사업자 정보가 통합되어 있을 가능성이 있음
	    - 스타벅스 전용 결제 시스템
	    - 스타벅스는 자체 충전식 카드 및 앱 내 결제를 제공하며, 이는 본사가 중앙에서 통합 관리
	    - 충전된 금액은 “선불”로 본사 계정에 저장되며, 매장에서 결제 시 본사가 각 매장으로 내부 정산

- 결론
    - 앱에서 카드 등록과 매장별 결제 및 정산은 PG사의 중앙 집중화된 결제 시스템을 통해 이루어짐
    - 매장별로 사업자가 달라도, PG사는 매장 ID 및 사업자 정보를 활용하여 정확히 정산
    - 스타벅스와 같은 경우, 자체 결제 시스템이 더해져 보다 효율적인 정산 체계를 구축할 수 있음

## 페이먼트 연동 관련 내용 정리

- 앱에서 가맹점 시스템으로 주문하는 플로우 (스마트 오더링, 예. 스타벅스 등)
  - 가맹점 / 메뉴 선택
  - 주문하기
  - 주문 내용 전달 --> 가맹점 시스템
  - 주문 내용 전달에 대한 응답
  - 주문 정보 업데이트
  - 가맹점 시스템으로부터 정보 전달 받음 (예. 주문 접수 / 대기열 / 등등)
  - 주문 정보 업데이트
  - 주문 확인 사항 사용자에게 전달
  - 주문한 음식 또는 물건의 제조의 완료
  - 제조완료 정보 전달
  - 주문 정보 업데이트
  - 주문한 것에 대한 제조가 완료되었음을 사용자에게 표시
  - 주문한 물건 또는 음식을 픽업
- PG 사 연동 시 결제 처리 흐름
  - 결제 준비
  - 결제 준비 요청에 대한 응답
  - 결제 승인
  - 결제 승인 요청에 대한 응답
  - 아래는 결제 취소 건에 대한 흐름
    - 결제 취소 요청
    - 결제 취소 요청에 대한 거래 결과 응답
    - 기타 정보 (정산 정보, 영수증 정보 조회 및 응답 처리)
   
## PG, VAN 사 개념 정리

- 온라인이든 오프라인이든 상점, 카드사, 금융기관이 서로 결제 정보를 주고 받을 망이 필요
- 오프라인 결제의 핵심, Value Added Network Van은 카드사와 상점의 통신을 연결하는 부가가치통신망이라 보면 됨
  - 오프라인 상점에서 입력한 고객의 결제 데이터를 카드사로 안전하게 보내주는 역할
  - 결제 정보를 주고 받는 일종의 파이프 역할
  - 업장에서 계산할 때 사용하는 카드 단말기 / 포스 단말기 모두 VAN 기반
  - 오프라인, 소비자 - 가맹점 - VAN (중계) - 카드사
    - 카드사는 VAN 사용료 지급 의무
    - VAN사는 중계 역할만 수행
    - 가맹점의 매출액 지급은 밴사가 관여하지 않음
    - 가맹점은 8개의 카드사로부터 매출액 각각 지급 받음(?)
  - VAN : 데이터를 안전하고 정확하게 연결해주는 역할만 함 (매출 정산 등의 추가 서비스 제공하지 않음)
    - 포스 단말기나 매출 장부 서비스 등을 사용하지 않으면 8개의 카드사에서 발생한 매출 내역을 따로따로 관리해야 함
    - VAN은 수수료가 없어서 고정비 절감 가능하나 가게 운영자의 역할이 늘어남 (8개 카드사로부터 각각 다른 날짜에 매출액을 입금받아야 함)
    - 신용카드 가맹점과 신용카드 회사 사이에서 신용카드 결제를 중계해주는 부가사업자
    - 신용카드 결제 -> 밴사 -> 신용카드사
    - KSNET / KIS정보통신 / 나이스정보통신 / KOVAN / 금융결제원 / fiserv. / DAOU데이터 / Smartro / KICC / NHN KCP / JTNet / KOCES / SPC NETWORKS.
    - VAN 사가 없다면 -> 매장마다 신용카드사별 전용 결제 단말기를 각각 설치해야 되는 상황 발생
  - PG : 온라인 결제의 핵심
    - Payments Gateway, 신용카드사와 직접 계약하기 어려운 온라인 쇼핑몰을 대신해 결제 업무를 대신해 주는 역할
    - 온라인, 소비자 - 가맹점 - PG - VAN - 카드사
    - 카드사는 가맹점에서 발생한 매출액을 PG 사에 지급
    - PG 사는 중계 역할 + 정산 역할 같이 수행
    - PG 사는 매출액을 가맹점에 지급 (PG 수수료 정산)
    - 여러 곳의 카드사와 거래를 가능하게 할 뿐 아니라 PG사와 계약한 정산일에 맞춰 한 번에 매출액을 정산해 줌
    - (이 정산 시스템은 카드사마다 매출 금액 지급일이 달라 발생할 수 있는 혼란을 없애고 현금 흐름을 쉽게 파악 가능케 함)
  - 가맹점 입장에서 VAN, PG 관련 체감할 수 있는 큰 차이점은 수수료
    - VAN 사는 가맹점 업주에게 수수료를 받지 않고 카드사로부터 수수료를 받음
    - PG 사는 PG사가 카드사에 수수료를 내고 결제를 연동하는 구조, 그리고 카드사마다 다른 매출 정산 내역을 일괄로 정산해주는 역할도 해주기 때문에 수수료가 발생
    - (즉, 밴사와 다르게 연동 구조도 다르고 제공되는 서비스가 많기에 수수료가 발생하는 것이라 이해)
    - 대표 PG 사: 토스페이먼츠 / KG이니시스 / 나이스페이먼츠 / NHN한국사이버결제
    - 온라인 결제 서비스 중에서도 VAN의 역할만 해주는 곳도 존재, 수수료를 줄일것인가, 매출 관리나 정산 업무를 강화시킬것인가에 대해 확인 후 선택 필요 

## PG, VAN 개념, 관계
  
  - VAN 개념
    - 카드사에 카드정보를 전달하는 중간업체
    - VAN사는 PG 또는 카드 단말기가 수집한 카드정보가 안전하게 안전하게 카드사로 전달 될 수 있도록 하는 일을 수행
    - 이를 위한 API 등을 제공

    - 온라인 결제 플로우
      - PG사가 카드 결제를 요청하면 VAN사는 그 요청을 카드사로 보내고, 카드사가 결제 요청 결과를 보내면 VAN사는 그 결과를 PG 전달
    - 오프라인 결제 플로우
      - 오프라인 결제에서 사용되는 단말기는 VAN사에서 제공하는 단말기
      - 이 단말기를 통해 카드 정보를 카드사에 전달
      - 최근에는 웹 기반 POS 기기나 테이블 결제 기기들이 많아 지면서 오프라인 결제라고 하더라도 PG를 통한 결제가 많아짐
      - PG사에서 제공하는 오프라인 결제용 단말기가 있는것 처럼, 최근에는 오프라인이면 무조건 VAN 단말기다 라는 개념이 많이 사라지고 있는 추세

  - PG 개념
    - 우리나라는 여러가지 이유로 카드 정보를 수집하여 결제하는 방식을 지양
    - 카드결제를 사용하기 위해 PG는 별도의 SDK나 API를 제공해 해당 방식으로만 카드정보를 입력받도록 하고 있음
    - 입력 된 정보를 따로 수집하진 않고, 카드사로 전달
    - 경우에 따라 정기 결제 처리 등을 위해 카드사에서 발급하는 키를 저장하고 그 키를 통해 결제를 처리하기도 하지만, 카드 정보는 수집하지 않음
    - 우리나라의 PG 사업자는 KCP, 나이스정보통신, KG 이니시스, 카카오 등 총 362개사(23/06/12 기준)
      - (PG사업자가 되려면 자본금이 3억 이상이여야 하고 엄격한 보안을 유지 하는 등 요건이 매우 까다로움)
    - PG 마다 다르지만 규모가 큰 PG의 경우 VAN을 사용하지 않는 경우도 존재

  - 비인증 결제
    - 일반적으로 결제시 마다 결제에 필요한 정보를 입력받는데 이를 비인증 결제라 함
    - 비인증 결제는 'key-in 결제'와 '빌링 결제' 결제로 다시 나뉘게 됨
      - key-in 결제
        - 카드번호, 유효기간, 카드 명의자의 생년월일, 카드 비밀번호 앞 2자리와 같은 카드 정보를 직접 입력하여 결제하는 방식
        - 입력받는 방식의 구분으로는 온라인 결제의 경우 PG에서 제공하는 SDK를 이용하는 방법과 API를 이용하는 2가지 방법 존재
        - 오프라인 결제에서는 카드 단말기나 POS기기 에서 API 통신을 통해 카드 정보를 입력받아 결제가 이루어짐
        - PG사에서 제공하는 결제창(SDK)을 사용하는 방법
          - KG 이니시스의 결제창
            - PG사에서 제공해주는 결제창을 통해 카드정보를 수집받음
            - 정보수집을 PG사에서 받고 바로 VAN을 통해 카드사로 전달
            - 가장 안전한 방법이라 가장 많이 사용되고 있고, 국내 대부분의 PG에서 사용하는 방식

          - PG사에서 제공하는 API를 사용하는 방법
            - 라프텔의 API 결제
              - 결제창 방법의 경우 기존 사이트의 디자인과 다른 PG사의 결제창이 툭 튀어나와 쇼핑몰의 이용자들이 당황하는 경우 발생
              - 대부분의 쇼핑몰의 경우 서비스 자체 디자인 한 카드 결제창을 사용하기를 희망
              - 사용자로 부터 입력받은 카드정보를 API를 통해 PG사에 제출 가능
              - 현재 국내에서는 나이스정보통신, PAYAPP 등 많지 않은 곳에서만 지원하는 방식
              - 개발 시 쇼핑몰의 시스템에서는 카드정보를 수집하지 않도록 처리해야 함
              - 쇼핑몰에서 입력받은 카드정보를 안전하게 PG로 전달할 수 있도록 보안처리가 필요하고 이는 직접 구축 필수

      - 빌링 결제
        - 라프텔의 경우 월 1회 마다 정기적으로 요금이 결제되게 됨
        - 최초 1회 카드 정보를 입력받는 것은 키인 결제와 동일하지만, 최초 결제이후 발행되는 빌링키를 이용하여 다음 결제 부터는 빌링키를 통해 결제가 이루어 지게 하여 결제를 처리
          - 빌링 결제 개념
        - 플랫폼에서는 빌링키 정보를 서버에 안전하게 보관하고 이 정보를 바탕으로 결제를 처리

  - 다른 결제 방식 존재 유무
    - 국내에서는 카드 결제 시스템에서 키인결제와 빌링 결제 2가지 이외에는 현실적으로 다른 결제 방식을 사용하기는 어려움

  - 왜 카드정보를 수집하지 않는지에 대한 설명
    - 유출시의 피해
      - 카드 번호와 같은 민감 정보가 서버에 보관되어있고 만약 서버의 정보 유출로 카드 번호 등이 유출되어 금전적 피해가 발생되었다면 법적인 문제를 제외하고도 이는 심각한 피해를 발생시키게 됨

    - 법적인 책임
      - 여신전문금융업법 제 17조 ①항의 내용을 보면, 선행 조건이 있긴 하지만 해당 조건을 제외하고 보면 가맹점의 고의 또는 중과실이 증명 될 경우 그 손실의 전부 또는 일부를 가맹점이 부담해야 한다는 내용 존재
      - 고의 또는 중과실에 관한 내용도 있는데 "해킹, 전산장애, 내부자정보유출 등 부정한 방법으로 얻은 신용카드등의 정보를 이용하여 신용카드등을 사용한 거래"라는 내용이 포함되어있어 해킹으로 인한 유출에 대한 책임을 져야 함
    - 이러한 법률로 인해 카드 정보를 저장하지 않는 방식으로 시스템이 발전되어 왔음

## PG, VAN, PG+VAN 개념
  - 결제 시스템에서 흔히 언급되는 VAN사(Value-Added Network)와 PG사(Payment Gateway)는 전자 결제의 중심적인 역할을 맡는 중계 업체들
  - 이 둘은 비슷해 보이지만, 역할과 기술적 위치가 다름
    
  - VAN사 (부가가치통신망 사업자)
    - 개념
	    - VAN은 오프라인 카드 결제(단말기 기반)를 위한 네트워크 제공자
	    - 카드 결제 단말기와 카드사 간의 통신을 중계하는 회사로, 카드 승인 요청/응답, 매출 전표 중계 등의 기능을 합니다.

    - 주요 역할
	    - 카드 단말기 설치 및 관리
	    - 카드 승인 요청 중계 (POS → VAN → 카드사)
	    - 거래 매입/정산 데이터 전송
	    - 부가 서비스 제공 (포인트 적립, 현금영수증 발행 등)

    - 대표 VAN사
	    - 나이스정보통신
	    - KIS정보통신
	    - 퍼스트데이터
	    - 스마트로
	    - 코밴 등

  - PG사 (Payment Gateway, 결제 대행사)
    - 개념
	    - PG사는 온라인 결제를 위한 전자 결제 인프라 제공 업체
	    - 온라인 쇼핑몰에서 카드사나 간편결제사 등과의 연결을 중계해주는 회사

    - 주요 역할
	    - 쇼핑몰과 카드사 간 결제 연동 중계
	    - 다양한 결제수단 통합 제공 (신용카드, 간편결제, 휴대폰 결제 등)
	    - 보안 인증, 암호화 처리 (예: ISP, 안심클릭)
	    - 거래 승인 및 매출정산 시스템 운영

    - 대표 PG사
	    - KG이니시스
	    - 나이스페이
	    - KCP
	    - 다날
	    - 토스페이먼츠
	    - 페이레터
	    - NHN KCP 등

  - VAN + PG 겸업사
    - 일부 회사는 VAN과 PG 양쪽 모두 사업을 수행
    - 겸업사 예시
	    - 나이스정보통신: VAN + PG
	    - KIS정보통신: VAN + PG
	    - 스마트로: VAN + PG
	    - KCP (NHN KCP): PG 중심이지만 VAN 기능도 일부 보유

  - 가맹점~카드사 결제 흐름 구조
    - 오프라인(단말기) 결제 구조
      1.	고객이 카드 삽입/터치
      2.	POS 단말기 → VAN사로 승인 요청
      3.	VAN사 → 카드사로 승인 요청 전달
      4.	카드사 → 승인 응답 (승인번호) 전달
      5.	승인된 결제 완료 및 매출 저장
      6.	VAN → 카드사로 매입 요청 (참고: 매입 > 물건/서비스 사들이다, 내것이 되도록 사들이는 것, 정산 요청의 의미)
      7.	카드사 → 가맹점 계좌로 정산

  - 온라인(PG) 결제 구조
	  1.	고객이 온라인 쇼핑몰에서 결제 진행
	  2.	쇼핑몰 서버 → PG사로 결제 정보 전달
	  3.	PG사 → 카드사(또는 간편결제, 휴대폰 결제사 등)에 승인 요청
	  4.	카드사 → 승인 응답
	  5.	PG사 → 쇼핑몰로 승인 결과 전달
	  6.	PG사 → 카드사로 매입 요청
	  7.	카드사 → PG사 → 쇼핑몰 정산 처리

  - 참고 개념
	  - 매입/정산: 카드사가 거래 내용을 확정하고 가맹점에 돈을 보내주는 과정
	  - 에스크로: 결제 금액을 제3자가 보관하고 구매확정 후 판매자에 송금하는 안전장치
	  - 간편결제사: 네이버페이, 카카오페이 등은 자체 PG 기능도 보유

## PG, VAN 사 정산주기 및 수수료, 정산흐름, 제로페이/QR결제 구조, 간편결제 플랫폼
  - 1. PG사 정산 주기 및 수수료
    - 정산 주기
      - 대부분 T+2일 또는 T+3일 정산 (T = 거래일), 거래일로부터 +2/+3일
      - 예: 5월 20일 결제 → 5월 22일 or 23일 가맹점 계좌로 입금
      - 주말/공휴일은 연기됨

    - 수수료
      - 기본 카드 결제 수수료: 약 3.0~3.5%
      - 소상공인 우대 수수료: 0.8~2.2% (카드사 정책에 따라 상이)
      - 간편결제·휴대폰 결제 등은 PG 수수료 + 통신사/결제사 수수료 포함

    - 참고: PG사는 카드사 수수료 + PG 중개 수수료를 합쳐 가맹점에 청구

  - 2. VAN사 정산 주기 및 수수료
    - 정산 주기
	  - 일반적으로 T+1일 또는 T+2일 정산
	  - 단말기를 통한 거래는 VAN이 승인만 중개하고 카드사에서 직접 정산

    - 수수료 구조
	  - 가맹점이 카드사와 수수료율을 계약하고, VAN사는 거래 1건당 20~50원 수준의 건당 수수료를 카드사로부터 수취함
	  - 가맹점 입장에서 VAN 수수료는 직접 부담하지 않음

  - 3. 정산 흐름 비교 (PG vs VAN)
    - PG 정산 흐름 (온라인 결제)
      - 고객 → 쇼핑몰 → PG사 → 카드사/결제사  
      - → 카드 승인 → PG 매입 요청 → 카드사 정산 → PG사 수취  
      - → PG → 쇼핑몰 계좌로 정산

    - VAN 정산 흐름 (오프라인 단말기)
      - 고객 → 단말기(VAN) → 카드사  
      - → 승인 응답 → 카드사 매입 → 카드사 → 가맹점 계좌로 정산

  - 4. 제로페이/QR결제 구조
    - 제로페이 개요
	  - 중간 수수료 없이 소상공인을 위한 직접 계좌 이체 기반 결제 시스템
	  - QR코드로 결제 → 고객 계좌에서 판매자 계좌로 직접 이체

    - 결제 흐름
      - 고객 → 제로페이 앱(QR 스캔) → 은행 이체 API 호출  
      - → 고객 계좌 → 판매자 계좌로 송금  
      - → 제로페이 서버로 승인 확인

    - 수수료
	  - 0~0.5% 수준 (대부분 0%)
	  - 민간 QR 결제보다 수수료가 획기적으로 저렴

  - 5. 간편결제 (카카오페이, 네이버페이 등)
    - 구조
	  - 고객이 카드나 계좌를 간편결제 앱에 등록 → 토큰화
	  - 결제 시, 앱이 대신 카드사에 승인 요청 (일종의 PG 역할 수행)

    - 주요 특징
	  - 간편결제사는 자체 PG 보유 (예: 카카오페이 PG, 네이버페이 PG)
      - 기본 PG수수료 + 간편결제 추가 수수료 (0.5~1.0%)가 더해짐
	  - 예: 일반 카드결제 수수료 2.8% → 카카오페이 결제 시 3.3%까지 상승 가능

  - 6. 자영업자/개발자 참고 Tip
	- VAN 단말기 설치 시 카드사 연동/VAN사 선택 주의
      - (나이스, KIS, 스마트로 등과 직접 계약)
	- PG사는 쇼핑몰에서 직접 계약하고 개발 연동 필요
      - (API 연동, 보안 인증 등 필수)
	- 간편결제/QR 연동은 PG사나 별도 연동사 필요
      - (카카오페이, 제로페이 개발자 센터 이용)

## 가맹점, 직영점 비교

- 운영 주체
  - 가맹점: 가맹점주(개인/법인)가 운영
  - 직영점: 본사(브랜드 소유 기업)가 직접 운영
- 소유권
  - 가맹점: 가맹점주의 자본과 소유
  - 직영점: 본사 자본과 소유
- 브랜드 사용권
  - 가맹점: 본사와 가맹계약 후 상표/로고/운영 매뉴얼 사용
  - 직영점: 본사 자체 사용(계약 불필요)
- 수익 구조
  - 가맹점: 매출은 가맹점주 수익, 일부는 로열티/물류비로 본사에 지급
  - 직영점: 매출 전액이 본사 수익
- 투자 부담
  - 가맹점: 가맹점 주가 점포 임대/인테리어/운영비 부담
  - 직영점: 본사가 전액 투자 및 운영비 부담
- 운영 자유도
  - 가맹점: 본사 매뉴얼에 따라 제한, 변형 어려움
  - 직영점: 본사 정책에 따라 자유롭게 조정 가능
- 위험 부담
  - 가맹점: 매출 부진/적자 등은 가맹점 주 부담
  - 직영점: 매출 부진/적자 등은 본사 부담
- 예시
  - 가맹점: 프랜차이즈 치킨집, 편의점 가맹점
  - 직영점: 대형마트 직영 매장, 본사 직영 카페

- 정리
  - 가맹점: 브랜드 빌려쓰고 내돈, 내책임으로 운영
  - 직영점: 본사가 직접 돈 내고 운영, 수익도 본사가 가져감